<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <title>GuardaMI Plant-ID - Area Metropolitana di Milano</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      /* --- STILE GENERALE --- */
      body {
        margin: 0;
        padding: 0;
        font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #2461b7;
        color: #12458c;
      }

      .page-wrapper {
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 24px 12px;
      }

      .form-all {
        background-color: #d6e7ff;
        max-width: 752px;
        width: 100%;
        border-radius: 8px;
        padding: 24px 20px 32px 20px;
        box-sizing: border-box;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      h1 {
        margin: 0 0 4px 0;
        font-size: 24px;
        text-align: center;
      }

      .form-subHeader {
        text-align: center;
        margin-bottom: 20px;
        font-size: 16px;
      }

      .form-line {
        margin-top: 12px;
        margin-bottom: 12px;
      }

      label {
        display: block;
        font-weight: 500;
        margin-bottom: 4px;
      }

      .required-star {
        color: #dc2626;
        margin-left: 3px;
      }

      input[type="text"],
      input[type="email"],
      input[type="date"],
      input[type="file"],
      textarea,
      .fake-input {
        width: 100%;
        max-width: 310px;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #9cb5dd;
        box-sizing: border-box;
        background-color: #ffffff;
        font-size: 14px;
      }

      input[readonly],
      textarea[readonly] {
        background-color: #f3f4ff;
      }

      .radio-inline {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .radio-inline label {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-weight: 400;
      }

      .help-text {
        font-size: 13px;
        color: #2c5fa6;
      }

      .section-title {
        font-weight: 600;
        margin-top: 18px;
        margin-bottom: 6px;
      }

      .text-block {
        font-size: 14px;
        text-align: justify;
      }

      .buttons-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        margin-top: 8px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: background-color 0.15s ease, transform 0.05s ease,
          box-shadow 0.15s ease;
        white-space: nowrap;
      }

      .btn-primary {
        background-color: #1d4ed8;
        color: #ffffff;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.2);
      }

      .btn-primary:hover:not(:disabled) {
        background-color: #1e40af;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(15, 23, 42, 0.25);
      }

      .btn-primary:disabled {
        background-color: #9ca3af;
        cursor: default;
        box-shadow: none;
      }

      .btn-full {
        width: 100%;
        max-width: 310px;
        justify-content: center;
      }

      /* Bottone "Dimentica dati salvati" con stessi colori del primario */
      .btn-secondary {
        background-color: #1d4ed8;
        color: #ffffff;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.2);
      }

      .btn-secondary:hover:not(:disabled) {
        background-color: #1e40af;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(15, 23, 42, 0.25);
      }

      /* Mappa */
      #map {
        width: 100%;
        height: 300px;
        border-radius: 6px;
        border: 1px solid #9cb5dd;
        overflow: hidden;
      }

      .map-coords {
        margin-top: 4px;
        font-size: 13px;
        color: #2c5fa6;
      }

      .warning {
        font-size: 13px;
        color: #b91c1c;
        margin-top: 4px;
        display: none;
      }

      hr {
        border: none;
        border-bottom: 1px solid #9cb5dd;
        margin: 16px 0;
      }

      .success-message {
        display: none;
        margin-top: 8px;
        font-size: 14px;
        color: #166534;
      }

      #interpretazioneAffidabilita {
        max-width: 100%;
        min-height: 60px;
      }

      @media (max-width: 600px) {
        .form-all {
          padding: 16px 12px 24px 12px;
        }
        .form-line {
          margin-top: 6px;
          margin-bottom: 6px;
        }
        #interpretazioneAffidabilita {
          width: 100%;
          min-height: 70px;
          line-height: 1.4;
          font-size: 14px;
        }
      }
    
      /* --- ANTEPRIMA IMMAGINI + LIGHTBOX --- */
      .image-preview-box {
        margin-top: 8px;
        padding: 12px 12px 10px;
        border-radius: 8px;
        border: 1px solid #9cb5dd;
        background-color: #edf2ff;
      }

      .preview-title {
        margin: 0 0 8px;
        font-size: 14px;
        font-weight: 600;
      }

      #previewContainer {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .thumbnail-wrapper {
        position: relative;
        display: inline-block;
      }

      .image-thumbnail {
        width: 90px;
        height: 90px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #9cb5dd;
        cursor: pointer;
        background-color: #ffffff;
      }

      .file-placeholder {
        width: 90px;
        height: 90px;
        border-radius: 6px;
        border: 1px dashed #9cb5dd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        padding: 4px;
        text-align: center;
        background-color: #f9fafb;
      }

      .thumbnail-delete {
        position: absolute;
        top: -6px;
        right: -6px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        border: none;
        background-color: rgba(220, 38, 38, 0.95);
        color: #ffffff;
        font-weight: bold;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(15, 23, 42, 0.35);
        transition: transform 0.15s ease, background-color 0.15s ease;
      }

      .thumbnail-delete:hover {
        background-color: rgba(185, 28, 28, 1);
        transform: scale(1.08);
      }

      #lightbox {
        position: fixed;
        inset: 0;
        background-color: rgba(15, 23, 42, 0.85);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      #lightbox.lightbox-visible {
        display: flex;
      }

      #lightbox img {
        max-width: 90vw;
        max-height: 80vh;
        border-radius: 10px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.45);
        background-color: #ffffff;
      }

      .lightbox-close {
        position: absolute;
        top: 16px;
        right: 18px;
        border: none;
        background: transparent;
        color: #ffffff;
        font-size: 32px;
        cursor: pointer;
        line-height: 1;
      }

      .lightbox-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        border-radius: 999px;
        border: none;
        width: 40px;
        height: 40px;
        font-size: 26px;
        cursor: pointer;
        background-color: rgba(15, 23, 42, 0.75);
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .lightbox-prev {
        left: 16px;
      }

      .lightbox-next {
        right: 16px;
      }

      /* --- BOX SPECIE --- */
      .species-box {
        margin-top: 10px;
        margin-bottom: 16px;
        padding: 16px 16px 12px;
        border-radius: 10px;
        border: 1px solid #9cb5dd;
        background-color: #f2f6ff;
      }

      .species-box-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
        padding-bottom: 6px;
        border-bottom: 1px solid #d0ddf5;
      }

      .species-title {
        font-weight: 600;
        font-size: 14px;
      }

      .btn-remove-species {
        border: none;
        background: transparent;
        color: #d11a1a;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        padding: 2px 4px;
        line-height: 1;
        border-radius: 6px;
        transition: background-color 0.15s ease, transform 0.15s ease;
      }

      .btn-remove-species:hover {
        background-color: rgba(209, 26, 26, 0.1);
        transform: scale(1.1);
      }

      .species-box[data-index="1"] .btn-remove-species {
        visibility: hidden;
      }

</style>
  </head>
  <body>
    <div class="page-wrapper">
      <div class="form-all">
        <h1>Area Metropolitana di Milano</h1>
        <div class="form-subHeader">
          GuardaMI Plant-ID ¬∑ Modulo di identificazione piante
        </div>
  <!-- DATI RILEVATORE -->
          <hr />
          <div class="section-title">Dati del rilevatore</div>

          <div class="form-line">
            <label for="nomeRilevatore">Nome Cognome</label>
            <input
              type="text"
              id="nomeRilevatore"
              name="nomeRilevatore"
              placeholder="Es. Mario Rossi"
            />
            <div class="help-text">
       
            </div>
          </div>
<div class="form-line">
  <label for="enteAppartenenza">Ente appartenenza / Titolo</label>
  <input
    type="text"
    id="enteAppartenenza"
    name="enteAppartenenza"
    placeholder="Es. Universit√† XY, Museo Storia Naturale..."
  />
</div>


          <div class="form-line">
            <label for="email">
              E-mail di riferimento <span class="required-star">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              placeholder="esempio@.it"
              required
            />
            <div class="help-text">
              L'indirizzo e-mail verr√† utilizzato solo per comunicazioni scientifiche.
            </div>
          </div>
<!-- NUOVA SEZIONE: gestione dati salvati su dispositivo -->
          <div class="form-line">
            <div class="buttons-row">
              <button
                type="button"
                class="btn btn-secondary"
                id="clearSavedUserData"
              >
                Dimentica dati salvati su questo dispositivo
              </button>
            </div>
            <div class="help-text">
              Nome, e-mail e ruolo vengono salvati <strong>solo su questo dispositivo</strong> per facilitare le segnalazioni future. Puoi cancellarli in qualsiasi momento.
            </div>
          </div>
        <!-- L'invio a Jotform viene fatto via fetch nel JavaScript. -->
        <form id="plant-form" action="#" method="post" enctype="multipart/form-data">
          <!-- ISTRUZIONI -->
          <div class="form-line">
            <div class="text-block">
              üå± <strong>Come compilare:</strong><br /><br />
              1. Carica <strong>una o due foto nitide</strong> della pianta (foglie, fiori o frutti ben visibili).<br />
              2. Clicca su <strong>‚ÄúIdentifica specie‚Äù</strong> per il riconoscimento automatico.
            </div>
          </div>

          <!-- UPLOAD + IDENTIFICA -->
          <div class="form-line">
            <label for="plantImage">
              File Upload <span class="required-star">*</span>
            </label>
            <input
              type="file"
              id="plantImage"
              name="plantImage"
              accept="image/*"
              onchange="handleImageSelection(event)"
              multiple
              required
            />

            <div class="buttons-row" style="margin-top: 10px">
              <button
                type="button"
                class="btn btn-primary"
                id="identifyButton"
              >
                Identifica Specie
              </button>
            </div>
            <div class="help-text">
            </div>
          </div>


          <!-- ANTEPRIMA FILE CARICATI -->
          <div class="form-line" id="previewLine" style="display: none;">
            <div class="image-preview-box">
              <h3 class="preview-title">Anteprima file caricati</h3>
              <div id="previewContainer"></div>
            </div>
          </div>
          <div class="form-line">
            <label for="dataAvvistamento">Data avvistamento</label>
            <input
              type="date"
              id="dataAvvistamento"
              name="dataAvvistamento"
            />
            <div class="help-text">
              Se la foto contiene la data di scatto, questo campo pu√≤ compilarsi automaticamente.
            </div>
          </div>
          <!-- SPECIE OSSERVATE -->
          <div class="section-title">Specie osservate</div>

          <div id="speciesFieldsContainer">
            <div class="species-box" data-index="1">
              <div class="species-box-header">
                <span class="species-title">Specie 1</span>
                <button
                  type="button"
                  class="btn-remove-species"
                  onclick="removeSpecies(this)"
                >
                  ‚ùå
                </button>
              </div>

              <div class="form-line">
                <label for="nomeComuneSpecie1">Nome comune</label>
                <input
                  type="text"
                  id="nomeComuneSpecie1"
                  name="nomeComuneSpecie[]"
                  placeholder="Es. Acero, Rovere..."
                />
              </div>

              <div class="form-line">
                <label for="nomeScientificoSpecie1">Nome scientifico</label>
                <input
                  type="text"
                  id="nomeScientificoSpecie1"
                  name="nomeScientificoSpecie[]"
                  placeholder="Es. Acer campestre"
                />
              </div>

              <div class="form-line">
                <label for="noteSpecie1">Note sulla specie</label>
                <textarea
                  id="noteSpecie1"
                  name="noteSpecie[]"
                  rows="2"
                  placeholder="Eventuali note, condizioni della pianta..."
                ></textarea>
              </div>
            </div>
          </div>

          <div class="form-line">
            <button
              type="button"
              class="btn btn-secondary"
              id="addSpeciesRow"
            >
              + Aggiungi specie
            </button>
          </div>


          <!-- GEOLOCALIZZAZIONE -->
          <hr />
          <div class="section-title">Geolocalizzazione</div>

          <div class="form-line">
            <div class="text-block" style="margin-bottom: 6px">
              üìç Se la foto include dati GPS, la posizione si compila automaticamente. In caso contrario verifica la mappa e, se necessario, trascina il marcatore sul punto corretto.
            </div>
            <div id="map"></div>
            <div class="map-coords">
              Coordinate selezionate:
              <span id="geolocDisplay">‚Äì</span>
            </div>
            <input type="hidden" id="geoloc" name="geoloc" />
          </div>

          <!-- ESITO IDENTIFICAZIONE -->
          <hr />
          <div class="section-title">üå± Risultato identificazione</div>

          <div class="form-line">
            <label for="affidabilita">Affidabilit√†</label>
            <input
              type="text"
              id="affidabilita"
              name="affidabilita"
              placeholder="es. 87%"
              readonly
            />
          </div>

          <div class="form-line">
            <label for="interpretazioneAffidabilita">Commento affidabilit√†</label>
            <textarea
              id="interpretazioneAffidabilita"
              name="interpretazioneAffidabilita"
              rows="3"
              placeholder="Analisi automatica del livello di affidabilit√†"
              readonly
            ></textarea>
          </div>

          <div class="form-line">
            <label for="nomeComune">Nome comune</label>
            <input
              type="text"
              id="nomeComune"
              name="nomeComune"
              placeholder="Nome comune (IT, se disponibile)"
              readonly
            />
          </div>

          <div class="form-line">
            <label for="nomeScientifico">Nome scientifico</label>
            <input
              type="text"
              id="nomeScientifico"
              name="nomeScientifico"
              placeholder="Nome scientifico"
              readonly
            />
          </div>

          <div class="form-line">
            <label for="allergenicita">Allergenicit√†</label>
            <input
              type="text"
              id="allergenicita"
              name="allergenicita"
              placeholder="Non disponibile / da compilare"
              readonly
            />
          </div>

          <!-- CONSENSO -->
          <hr />
          <div class="section-title">Consenso al trattamento dati</div>

          <div class="form-line">
            <div class="text-block" style="margin-bottom: 6px">
              Autorizzo il trattamento dei dati personali ai sensi del Regolamento (UE) 2016/679 (GDPR).<br /><br />
              Le informazioni inserite nel modulo e i <strong>metadati delle immagini</strong> (es. data di scatto e coordinate GPS) sono utilizzati <strong>solo per l‚Äôidentificazione della specie vegetale e per registrare la segnalazione</strong>.<br /><br />
              Nessun dato viene utilizzato per finalit√† diverse da quelle indicate.
            </div>
            <div class="radio-inline">
              <label>
                <input
                  type="radio"
                  name="consenso"
                  value="Acconsento"
                />
                Acconsento
              </label>
              <label>
                <input
                  type="radio"
                  name="consenso"
                  value="Non Acconsento"
                />
                Non Acconsento
              </label>
            </div>
            <div id="consentWarning" class="warning">
              Per inviare il modulo √® necessario selezionare ‚ÄúAcconsento‚Äù.
            </div>
          </div>

          <!-- INVIO -->
          <div class="form-line" style="margin-top: 20px">
            <button
              type="submit"
              class="btn btn-primary btn-full"
              id="submitButton"
              disabled
            >
              Invia
            </button>
            <div id="successMessage" class="success-message">
              ‚úÖ Modulo inviato con successo! Puoi inserire una nuova segnalazione.
            </div>
            <div class="help-text" style="margin-top: 4px">
              Il riconoscimento √® generato automaticamente da PlantNet e fornisce un‚Äôindicazione preliminare, da confermare se necessario con verifica botanica.
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Libreria per leggere EXIF (data + GPS) dai JPG/PNG -->
    <script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>
    <script src="https://unpkg.com/exifr/dist/full.umd.js"></script>

    <!-- SCRIPT PRINCIPALE -->
    <script>
      // URL di Jotform
      const JOTFORM_URL = "https://eu-submit.jotform.com/submit/253044075525049";

      // Chiave per localStorage: dati utente (nome, email, chiSei)
      const USER_DATA_STORAGE_KEY = "guardaMI_plantid_userdata";

      // Chiamata alla Function Netlify plantnet-identify
      async function callPlantNetIdentify(imageBase64) {
        const response = await fetch("/.netlify/functions/plantnet-identify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ imageBase64 }),
        });

        if (!response.ok) {
          const text = await response.text();
          console.error("Errore da PlantNet/Function:", response.status, text);
          throw new Error("Errore dalla funzione di identificazione");
        }

        return response.json();
      }

      
      // File ‚Üí Base64 con supporto HEIC/HEIF ‚Üí JPG
      async function fileToBase64(file) {
        const fileName = (file.name || "").toLowerCase();
        const fileType = (file.type || "").toLowerCase();

        const isHeic =
          fileType.includes("heic") ||
          fileName.endsWith(".heic") ||
          fileName.endsWith(".heif");

        let fileToProcess = file;

        if (isHeic) {
          try {
            const convertedBlob = await heic2any({
              blob: file,
              toType: "image/jpeg",
              quality: 0.9,
            });
            fileToProcess = convertedBlob;
          } catch (err) {
            console.error("Errore nella conversione HEIC:", err);
            throw new Error("Impossibile convertire il file HEIC ‚Üí JPG");
          }
        }

        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const result = reader.result || "";
            const base64 = String(result).split(",")[1] || "";
            resolve(base64);
          };
          reader.onerror = () => reject(new Error("Errore nella lettura del file"));
          reader.readAsDataURL(fileToProcess);
        });
      }
document.addEventListener("DOMContentLoaded", () => {
        const imageInput = document.getElementById("plantImage");
        const identifyButton = document.getElementById("identifyButton");

        const nomeComuneInput = document.getElementById("nomeComune");
        const nomeScientificoInput = document.getElementById("nomeScientifico");
        const affidabilitaInput = document.getElementById("affidabilita");
        const interpretazioneInput = document.getElementById(
          "interpretazioneAffidabilita"
        );
        const allergenicitaInput = document.getElementById("allergenicita");

        const submitButton = document.getElementById("submitButton");
        const consentWarning = document.getElementById("consentWarning");
        const successMessage = document.getElementById("successMessage");

        const consentRadios = document.querySelectorAll(
          'input[name="consenso"]'
        );

        const nomeRilevatore = document.getElementById("nomeRilevatore");
        const emailInput = document.getElementById("email");
        const dataAvvistamento = document.getElementById("dataAvvistamento");
        const geolocInput = document.getElementById("geoloc");
        const geolocDisplay = document.getElementById("geolocDisplay");
        const clearSavedUserDataButton = document.getElementById("clearSavedUserData");

        const form = document.getElementById("plant-form");

        // --- FUNZIONI PER SALVATAGGIO DATI UTENTE SU DISPOSITIVO ---

        function loadUserDataFromStorage() {
          try {
            const raw = window.localStorage.getItem(USER_DATA_STORAGE_KEY);
            if (!raw) return;
            const data = JSON.parse(raw);

            if (data.nomeRilevatore && nomeRilevatore) {
              nomeRilevatore.value = data.nomeRilevatore;
            }
            if (data.email && emailInput) {
              emailInput.value = data.email;
            }
} catch (e) {
            console.warn("Impossibile caricare i dati utente da localStorage:", e);
          }
        }

        
        function saveUserDataToStorage() {
          try {
            const data = {
              nomeRilevatore: nomeRilevatore ? nomeRilevatore.value || "" : "",
              email: emailInput ? emailInput.value || "" : "",
            };
            window.localStorage.setItem(
              USER_DATA_STORAGE_KEY,
              JSON.stringify(data)
            );
            // Dati condivisi con la home (solo nome + mail)
            const homeData = {
              nome: nomeRilevatore ? nomeRilevatore.value || "" : "",
              mail: emailInput ? emailInput.value || "" : "",
            };
            window.localStorage.setItem("userData", JSON.stringify(homeData));
          } catch (e) {
            console.warn("Impossibile salvare i dati utente in localStorage:", e);
          }
        }

        
        function clearUserDataFromStorageAndForm() {
          try {
            window.localStorage.removeItem(USER_DATA_STORAGE_KEY);
          } catch (e) {
            console.warn("Impossibile rimuovere i dati utente da localStorage:", e);
          }
          try {
            window.localStorage.removeItem("userData");
          } catch (e) {
            console.warn("Impossibile rimuovere i dati condivisi con la home da localStorage:", e);
          }
          if (nomeRilevatore) nomeRilevatore.value = "";
          if (emailInput) emailInput.value = "";
        }

        // Carica eventuali dati salvati al primo caricamento pagina
        loadUserDataFromStorage();

        // Salva automaticamente quando questi campi cambiano
        if (nomeRilevatore) {
          nomeRilevatore.addEventListener("change", saveUserDataToStorage);
        }
        if (emailInput) {
          emailInput.addEventListener("change", saveUserDataToStorage);
        }
        // Bottone "Dimentica dati salvati su questo dispositivo"
        if (clearSavedUserDataButton) {
          clearSavedUserDataButton.addEventListener("click", () => {
            clearUserDataFromStorageAndForm();
            alert(
              "I dati di nome ed e-mail salvati su questo dispositivo sono stati cancellati."
            );
          });
        }

        // üîî Popup immediato se viene caricato un HEIC + lettura EXIF JPG/PNG
        imageInput.addEventListener("change", async () => {
          const file = imageInput.files && imageInput.files[0];
          if (!file) return;

          const fileName = (file.name || "").toLowerCase();
          const fileType = (file.type || "").toLowerCase();

          const isHeic =
            fileType.includes("heic") ||
            fileName.endsWith(".heic") ||
            fileName.endsWith(".heif");

          // Se non √® HEIC e la libreria exifr √® presente, proviamo a leggere EXIF
          if (window.exifr && typeof exifr.parse === "function") {
            try {
              const meta = await exifr.parse(file);

              if (meta) {
                // Data di scatto ‚Üí DateTimeOriginal
                if (meta.DateTimeOriginal instanceof Date && dataAvvistamento) {
                  const d = meta.DateTimeOriginal;
                  const yyyy = d.getFullYear();
                  const mm = String(d.getMonth() + 1).padStart(2, "0");
                  const dd = String(d.getDate()).padStart(2, "0");
                  dataAvvistamento.value = `${yyyy}-${mm}-${dd}`;
                }

                // GPS ‚Üí latitude / longitude in decimali
                if (
                  typeof meta.latitude === "number" &&
                  typeof meta.longitude === "number" &&
                  geolocInput &&
                  geolocDisplay
                ) {
                  const coords = {
                    lat: meta.latitude,
                    lng: meta.longitude,
                  };

                  // Aggiorna mappa e marker (se gi√† inizializzati)
                  if (window.map && window.marker) {
                    window.map.setCenter(coords);
                    window.marker.setPosition(coords);
                  }

                  const val =
                    coords.lat.toFixed(6) + ", " + coords.lng.toFixed(6);
                  geolocInput.value = val;
                  geolocDisplay.textContent = val;
                }
              }
            } catch (ex) {
              console.warn("Impossibile leggere EXIF dall'immagine:", ex);
            }
          }
        });

        // Gestione consenso (abilita/disabilita INVIA)
        consentRadios.forEach((radio) => {
          radio.addEventListener("change", () => {
            if (radio.value === "Acconsento" && radio.checked) {
              submitButton.disabled = false;
              consentWarning.style.display = "none";
            } else if (radio.value === "Non Acconsento" && radio.checked) {
              submitButton.disabled = true;
              consentWarning.style.display = "block";
            }
          });
        });

        // IDENTIFICA SPECIE
        identifyButton.addEventListener("click", async () => {
          if (!imageInput.files || !imageInput.files[0]) {
            alert("Per favore carica prima almeno una foto della pianta.");
            return;
          }

          if (imageInput.files.length > 2) {
            alert("Puoi caricare al massimo 2 foto.");
            return;
          }

          const file = imageInput.files[0]; // prima foto per PlantNet
          const fileName = (file.name || "").toLowerCase();
          const fileType = (file.type || "").toLowerCase();

          const isHeic =
            fileType.includes("heic") ||
            fileName.endsWith(".heic") ||
            fileName.endsWith(".heif");

          const originalText = identifyButton.textContent;
          identifyButton.textContent = "Identificazione in corso...";
          identifyButton.disabled = true;

          try {
            const base64 = await fileToBase64(file);

            if (!base64) {
              alert("Errore nella lettura dell'immagine.");
              identifyButton.textContent = originalText;
              identifyButton.disabled = false;
              return;
            }

            const result = await callPlantNetIdentify(base64);

            // se PlantNet non trova specie
            if (!result || !result.scientificName) {
              alert(
                "Nessuna specie trovata.\n\n" +
                  "Prova a caricare una foto pi√π chiara e ravvicinata " +
                  "della pianta (foglie, fiori o frutti ben visibili)."
              );
              identifyButton.textContent = originalText;
              identifyButton.disabled = false;
              return;
            }

            nomeScientificoInput.value = result.scientificName || "";
            nomeComuneInput.value = result.commonName || "";
            allergenicitaInput.value = result.allergenicity || "N/D";

            // Interpretazione affidabilit√†
            let rawReliability = parseFloat(result.reliability);
            if (isNaN(rawReliability)) rawReliability = 0;

            let percentuale = 0;
            if (rawReliability <= 1) {
              percentuale = Math.round(rawReliability * 100);
            } else {
              percentuale = Math.round(rawReliability);
            }

            function getAffidabilita(percentuale) {
              let testo = "", colore = "", icona = "";
              if (percentuale >= 90) {
                testo = "Altamente probabile che la specie sia corretta.";
                colore = "#00b050"; icona = "‚úÖ";
              } else if (percentuale >= 70) {
                testo = "Buona probabilit√† che il genere sia corretto, ma la specie potrebbe essere confusa con altre simili.";
                colore = "#92d050"; icona = "üîé";
              } else if (percentuale >= 50) {
                testo = "Riconoscimento plausibile: probabile che il genere sia corretto, ma la specie √® solo una delle possibili.";
                colore = "#ffc000"; icona = "‚ö†Ô∏è";
              } else if (percentuale >= 30) {
                testo = "Bassa affidabilit√†: pu√≤ aver confuso la pianta con specie simili.";
                colore = "#ff6600"; icona = "‚ùå";
              } else {
                testo = "Risultato poco significativo: ripeti la foto o prova un‚Äôaltra angolazione.";
                colore = "#ff0000"; icona = "üö´";
              }
              return { testo, colore, icona };
            }

            const info = getAffidabilita(percentuale);

            affidabilitaInput.value = `${percentuale}%`;

            if (interpretazioneInput) {
              interpretazioneInput.value = `${info.icona} ${percentuale}% ‚Äì ${info.testo}`;
              interpretazioneInput.style.color = info.colore;
              interpretazioneInput.style.fontWeight = "bold";
            }

            window.scrollTo({
              top:
                nomeScientificoInput.getBoundingClientRect().top +
                window.scrollY -
                80,
              behavior: "smooth",
            });
          } catch (err) {
            console.error(err);
            alert("Errore imprevisto durante l'identificazione.");
          } finally {
            identifyButton.textContent = originalText;
            identifyButton.disabled = false;
          }
        });

        // INVIO A JOTFORM
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          successMessage.style.display = "none";

          const consentValue = (
            new FormData(form).get("consenso") || ""
          ).toString();
          if (consentValue !== "Acconsento") {
            submitButton.disabled = true;
            consentWarning.style.display = "block";
            window.scrollTo({
              top: document.body.scrollHeight,
              behavior: "smooth",
            });
            return;
          }

          if (!imageInput.files || !imageInput.files[0]) {
            alert("Per inviare il modulo devi caricare almeno una foto.");
            return;
          }

          if (imageInput.files.length > 2) {
            alert("Puoi caricare al massimo 2 foto.");
            return;
          }

          const originalText = submitButton.textContent;
          submitButton.disabled = true;
          submitButton.textContent = "Invio in corso...";

          // üîê Prima dell'invio, salviamo/aggiorniamo i dati utente in localStorage
          saveUserDataToStorage();

          try {
            const formData = new FormData();

            formData.append("formID", "253044075525049");

            // tutte le foto caricate (max 2)
            for (let i = 0; i < imageInput.files.length; i++) {
              formData.append("q8_fileUpload[]", imageInput.files[i]);
            }

            formData.append("q7_Nome_comune", nomeComuneInput.value || "");
            formData.append(
              "q9_Nome_Scientifico",
              nomeScientificoInput.value || ""
            );
            formData.append("q12_affidabilita", affidabilitaInput.value || "");
            formData.append(
              "q13_allergenicita",
              allergenicitaInput.value || ""
            );

            // Nome facoltativo ‚Üí tutto in "first"
            formData.append(
              "q22_rilevatore[first]",
              nomeRilevatore.value || ""
            );
            formData.append("q22_rilevatore[last]", "");

            formData.append("q23_email", emailInput.value || "");

            const dateStr = (dataAvvistamento.value || "").trim();
            if (dateStr) {
              const parts = dateStr.split("-");
              if (parts.length === 3) {
                const year = parts[0];
                const month = parts[1];
                const day = parts[2];
                formData.append("q25_dataAvvistamento[day]", day);
                formData.append("q25_dataAvvistamento[month]", month);
                formData.append("q25_dataAvvistamento[year]", year);
              }
            }

            formData.append("q21_scriviUna", geolocInput.value || "");
            formData.append("q27_ilSottoscritto", consentValue);

            // Interpretazione affidabilit√† ‚Üí campo Jotform q30
            if (interpretazioneInput && interpretazioneInput.value) {
              formData.append(
                "q30_interpretazioneAffidabilita",
                interpretazioneInput.value
              );
            }

            await fetch(JOTFORM_URL, {
              method: "POST",
              mode: "no-cors",
              body: formData,
            });

            successMessage.style.display = "block";
            alert(
              "Modulo inviato con successo! Riceverai la conferma da Jotform. Puoi inserire una nuova segnalazione."
            );

            form.reset();
            submitButton.disabled = true;
            consentWarning.style.display = "none";
            submitButton.textContent = originalText;

            nomeComuneInput.value = "";
            nomeScientificoInput.value = "";
            affidabilitaInput.value = "";
            allergenicitaInput.value = "";
            if (interpretazioneInput) {
              interpretazioneInput.value = "";
              interpretazioneInput.style.color = "";
              interpretazioneInput.style.fontWeight = "";
            }

            if (window.marker && window.map && window.defaultLatLng) {
              window.marker.setPosition(window.defaultLatLng);
              window.map.setCenter(window.defaultLatLng);
              const val =
                window.defaultLatLng.lat.toFixed(6) +
                ", " +
                window.defaultLatLng.lng.toFixed(6);
              geolocInput.value = val;
              geolocDisplay.textContent = val;
            }

            // Dopo reset del form, ricarichiamo i dati salvati su dispositivo
            loadUserDataFromStorage();

            window.scrollTo({ top: 0, behavior: "smooth" });
          } catch (err) {
            console.error(err);
            alert(
              "Si √® verificato un errore durante l'invio. Per favore riprova tra poco."
            );
            submitButton.disabled = false;
            submitButton.textContent = originalText;
          }
        });
      });

      // --- GOOGLE MAPS ---
      window.defaultLatLng = { lat: 45.4642, lng: 9.19 }; // Milano
      let map, marker;

      function initMap() {
        const mapEl = document.getElementById("map");
        if (!mapEl) return;

        map = new google.maps.Map(mapEl, {
          center: window.defaultLatLng,
          zoom: 11,
        });
        window.map = map;

        marker = new google.maps.Marker({
          position: window.defaultLatLng,
          map,
          draggable: true,
        });
        window.marker = marker;

        const geolocInput = document.getElementById("geoloc");
        const geolocDisplay = document.getElementById("geolocDisplay");

        function updateHiddenFromLatLng(latLng) {
          if (!latLng || !geolocInput || !geolocDisplay) return;
          const value =
            latLng.lat().toFixed(6) + ", " + latLng.lng().toFixed(6);
          geolocInput.value = value;
          geolocDisplay.textContent = value;
        }

        updateHiddenFromLatLng(marker.getPosition());

        marker.addListener("dragend", () => {
          updateHiddenFromLatLng(marker.getPosition());
        });

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const coords = {
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
              };
              map.setCenter(coords);
              marker.setPosition(coords);
              updateHiddenFromLatLng(marker.getPosition());
            },
            (err) => {
              console.warn("Geolocalizzazione non disponibile:", err);
            }
          );
        }
      }
    </script>


    <!-- LIGHTBOX PER ANTEPRIMA IMMAGINI -->
    <div id="lightbox" aria-hidden="true">
      <button
        type="button"
        class="lightbox-close"
        onclick="closeLightbox()"
        aria-label="Chiudi anteprima"
      >
        √ó
      </button>
      <button
        type="button"
        class="lightbox-arrow lightbox-prev"
        onclick="prevImage()"
        aria-label="Immagine precedente"
      >
        ‚Äπ
      </button>
      <img id="lightboxImage" alt="Immagine ingrandita" />
      <button
        type="button"
        class="lightbox-arrow lightbox-next"
        onclick="nextImage()"
        aria-label="Immagine successiva"
      >
        ‚Ä∫
      </button>
    </div>


    <script>
      // --- ANTEPRIMA IMMAGINI + LIGHTBOX CON SUPPORTO HEIC ---
      let originalFiles = [];    // File originali dall'input
      let previewBlobs = [];     // Blob usati per anteprima/lightbox (JPG se HEIC convertito)
      let currentLightboxIndex = 0;

      // Helper: controlla se il file √® HEIC
      function isHeicFile(file) {
        const type = (file.type || "").toLowerCase();
        const name = (file.name || "").toLowerCase();
        return type.includes("heic") || name.endsWith(".heic") || name.endsWith(".heif");
      }

      // Converte HEIC -> JPEG per la sola ANTEPRIMA
      async function convertHeicForPreview(file) {
        if (!isHeicFile(file) || !window.heic2any) {
          // Non √® HEIC o libreria non disponibile ‚Üí uso il file cos√¨ com'√®
          return file;
        }

        try {
          const result = await heic2any({
            blob: file,
            toType: "image/jpeg",
            quality: 0.8,
          });

          // heic2any pu√≤ restituire un Blob o un array di Blob
          if (result instanceof Blob) return result;
          if (Array.isArray(result) && result[0] instanceof Blob) return result[0];

          console.warn("Risultato HEIC non previsto, uso file originale per anteprima.");
          return file;
        } catch (e) {
          console.warn("Errore conversione HEIC per anteprima:", e);
          return file; // in caso di errore, non blocchiamo tutto
        }
      }

      // Viene chiamata dall'input file: onchange="handleImageSelection(event)"
      async function handleImageSelection(event) {
        const input = event.target;
        if (!input || !input.files) return;

        originalFiles = Array.from(input.files);

        // Preparo i blob da usare per anteprima (con conversione HEIC se serve)
        previewBlobs = [];
        for (const file of originalFiles) {
          const blob = await convertHeicForPreview(file);
          previewBlobs.push(blob);
        }

        renderPreviews();
      }

      function renderPreviews() {
        const previewLine = document.getElementById("previewLine");
        const container = document.getElementById("previewContainer");
        if (!previewLine || !container) return;

        container.innerHTML = "";

        if (!previewBlobs.length) {
          previewLine.style.display = "none";
          return;
        }

        previewLine.style.display = "block";

        previewBlobs.forEach((blob, index) => {
          const wrapper = document.createElement("div");
          wrapper.className = "thumbnail-wrapper";

          const isImage =
            blob &&
            blob.type &&
            blob.type.toLowerCase().startsWith("image/");

          if (isImage) {
            const img = document.createElement("img");
            img.className = "image-thumbnail";
            img.src = URL.createObjectURL(blob);
            img.alt =
              (originalFiles[index] && originalFiles[index].name) ||
              "Immagine " + (index + 1);
            img.addEventListener("click", () => openLightbox(index));
            wrapper.appendChild(img);
          } else {
            const placeholder = document.createElement("div");
            placeholder.className = "file-placeholder";
            placeholder.textContent =
              (originalFiles[index] && originalFiles[index].name) ||
              "File";
            wrapper.appendChild(placeholder);
          }

          const del = document.createElement("button");
          del.type = "button";
          del.className = "thumbnail-delete";
          del.textContent = "√ó";
          del.addEventListener("click", (ev) => {
            ev.stopPropagation();
            deletePreviewFile(index);
          });

          wrapper.appendChild(del);
          container.appendChild(wrapper);
        });

        syncFileInputFromPreviews();
      }

      function deletePreviewFile(index) {
        if (index < 0 || index >= originalFiles.length) return;
        originalFiles.splice(index, 1);
        previewBlobs.splice(index, 1);
        renderPreviews();
      }

      // Mantiene l'input file allineato ai file ancora in anteprima (ma sempre con gli originali, NON i convertiti)
      function syncFileInputFromPreviews() {
        const input = document.getElementById("plantImage");
        if (!input) return;
        const dt = new DataTransfer();
        originalFiles.forEach((file) => dt.items.add(file));
        input.files = dt.files;
      }

      function openLightbox(index) {
        if (!previewBlobs.length) return;
        currentLightboxIndex = index;
        const lightbox = document.getElementById("lightbox");
        const img = document.getElementById("lightboxImage");
        if (!lightbox || !img) return;

        const blob = previewBlobs[currentLightboxIndex];
        if (!blob) return;

        img.src = URL.createObjectURL(blob);
        lightbox.classList.add("lightbox-visible");
        lightbox.setAttribute("aria-hidden", "false");
      }

      function closeLightbox() {
        const lightbox = document.getElementById("lightbox");
        const img = document.getElementById("lightboxImage");
        if (!lightbox || !img) return;
        lightbox.classList.remove("lightbox-visible");
        lightbox.setAttribute("aria-hidden", "true");
        img.removeAttribute("src");
      }

      function nextImage() {
        if (!previewBlobs.length) return;
        currentLightboxIndex =
          (currentLightboxIndex + 1) % previewBlobs.length;
        openLightbox(currentLightboxIndex);
      }

      function prevImage() {
        if (!previewBlobs.length) return;
        currentLightboxIndex =
          (currentLightboxIndex - 1 + previewBlobs.length) %
          previewBlobs.length;
        openLightbox(currentLightboxIndex);
      }

      document.addEventListener("keydown", function (ev) {
        const lightbox = document.getElementById("lightbox");
        if (!lightbox || !lightbox.classList.contains("lightbox-visible"))
          return;
        if (ev.key === "Escape") {
          closeLightbox();
        } else if (ev.key === "ArrowRight") {
          nextImage();
        } else if (ev.key === "ArrowLeft") {
          prevImage();
        }
      });

document.addEventListener("DOMContentLoaded", function () {
        const lightbox = document.getElementById("lightbox");
        if (lightbox) {
          lightbox.addEventListener("click", function (ev) {
            if (ev.target === lightbox) {
              closeLightbox();
            }
          });
        }

        // --- BOX SPECIE DINAMICI ---
        const container = document.getElementById(
          "speciesFieldsContainer"
        );
        const addBtn = document.getElementById("addSpeciesRow");
        if (!container || !addBtn) return;

        const template = container.querySelector(".species-box");
        if (!template) return;

        addBtn.addEventListener("click", function () {
          const clone = template.cloneNode(true);

          const existingBoxes = container.querySelectorAll(".species-box");
          const newIndex = existingBoxes.length + 1;

          clone.dataset.index = String(newIndex);
          const title = clone.querySelector(".species-title");
          if (title) {
            title.textContent = "Specie " + newIndex;
          }

          clone.querySelectorAll("input, textarea").forEach(function (el) {
            if (el.type === "checkbox" || el.type === "radio") {
              el.checked = false;
            } else {
              el.value = "";
            }
          });

          clone.querySelectorAll("[id]").forEach(function (el) {
            const oldId = el.id;
            if (!oldId) return;
            const base = oldId.replace(/\d+$/, "");
            el.id = base + newIndex;
          });

          clone.querySelectorAll("label[for]").forEach(function (label) {
            const oldFor = label.getAttribute("for");
            if (!oldFor) return;
            const base = oldFor.replace(/\d+$/, "");
            label.setAttribute("for", base + newIndex);
          });

          container.appendChild(clone);
        });
      });

      function removeSpecies(btn) {
        const box = btn.closest(".species-box");
        const container = document.getElementById("speciesFieldsContainer");
        if (!box || !container) return;

        const boxes = container.querySelectorAll(".species-box");
        if (boxes.length <= 1) return;

        box.remove();

        Array.from(container.querySelectorAll(".species-box")).forEach(function (
          b,
          idx
        ) {
          const index = idx + 1;
          b.dataset.index = String(index);
          const title = b.querySelector(".species-title");
          if (title) {
            title.textContent = "Specie " + index;
          }
        });
      }
    </script>

    <!-- GOOGLE MAPS -->
    <script
      async
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4l9n-f6M3LfIw6Qxh9e6e84jgTfMAyGU&callback=initMap"
    ></script>
  </body>
</html>
